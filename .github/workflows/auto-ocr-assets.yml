name: ğŸ” Auto OCR Assets Scanner

on:
  push:
    paths:
      - '**/assets/**/*.png'
      - '**/assets/**/*.jpg'
      - '**/assets/**/*.jpeg'
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

jobs:
  ocr-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install Tesseract OCR
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr tesseract-ocr-eng tesseract-ocr-fra
          tesseract --version
      
      - name: ğŸ“š Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install Pillow pytesseract beautifulsoup4 lxml
      
      - name: ğŸ¯ Run OCR Assets Scanner
        run: |
          echo "ğŸ” Starting OCR scan..."
          python3 ocr-assets-scanner.py --repo . --output assets_ocr_index.json
          echo "âœ… OCR scan completed"
      
      - name: ğŸ”„ Merge with mega-search-index
        run: |
          echo "ğŸ”„ Merging indexes..."
          if [ -f fusion-all-indexes.py ]; then
            python3 fusion-all-indexes.py --repo . --output mega-search-index.json
            echo "âœ… mega-search-index.json updated"
          else
            echo "âš ï¸  fusion-all-indexes.py not found"
          fi
      
      - name: ğŸ’¾ Commit OCR results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add assets_ocr_index.json mega-search-index.json || true
          git diff --staged --quiet || git commit -m "ğŸ” Auto-update: OCR assets scan [skip ci]"
          git pull --rebase origin main || true
          git push || true
      
      - name: ğŸ“ˆ Display Statistics
        if: always()
        run: |
          echo "ğŸ“Š OCR Scan Statistics"
          if [ -f assets_ocr_index.json ]; then
            echo "âœ… assets_ocr_index.json created"
            cat assets_ocr_index.json | grep -o '"total_scanned":[0-9]*' || echo "Stats not available"
          else
            echo "âŒ No OCR index found"
          fi
