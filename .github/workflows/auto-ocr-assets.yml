name: ğŸ” Auto OCR Assets Scanner

on:
  push:
    paths:
      - '**/assets/**/*.png'
      - '**/assets/**/*.jpg'
      - '**/assets/**/*.jpeg'
  workflow_dispatch:
  schedule:
    # Scan quotidien Ã  3h du matin (UTC)
    - cron: '0 3 * * *'

jobs:
  ocr-scan:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout du repo
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # 2. Setup Python
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # 3. Installer Tesseract OCR
      - name: ğŸ“¦ Install Tesseract OCR
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr tesseract-ocr-eng tesseract-ocr-fra
          tesseract --version
      
      # 4. Installer dÃ©pendances Python
      - name: ğŸ“š Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install Pillow pytesseract beautifulsoup4 lxml
      
      # 5. Scanner les images avec OCR
      - name: ğŸ¯ Run OCR Assets Scanner
        run: |
          echo "ğŸ” Starting OCR scan..."
          python3 ocr-assets-scanner.py --repo . --output assets_ocr_index.json
          
          echo ""
          echo "ğŸ“Š Scan results:"
          if [ -f assets_ocr_index.json ]; then
            echo "âœ… assets_ocr_index.json created"
            cat assets_ocr_index.json | python3 -c "import sys, json; data=json.load(sys.stdin); print(f\"   Total: {data.get('total_scanned', 0)} resources\")"
          else
            echo "âŒ assets_ocr_index.json not found!"
            exit 1
          fi
      
      # 6. Fusionner avec le mega-index
      - name: ğŸ”„ Merge with mega-search-index
        run: |
          echo "ğŸ”„ Merging indexes..."
          if [ -f fusion-all-indexes.py ]; then
            python3 fusion-all-indexes.py --repo . --output mega-search-index.json
            echo "âœ… mega-search-index.json updated"
          else
            echo "âš ï¸  fusion-all-indexes.py not found, skipping merge"
          fi
      
      # 7. Commit les changements
      - name: ğŸ’¾ Commit OCR results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add assets_ocr_index.json mega-search-index.json
          
          if git diff --staged --quiet; then
            echo "ğŸ“ No changes to commit"
          else
            git commit -m "ğŸ” Auto-update: OCR assets scan [skip ci]"
            
            # Pull avant push pour Ã©viter conflits
            git pull --rebase origin main || true
            
            # Push avec retry
            for i in {1..3}; do
              if git push; then
                echo "âœ… Changes pushed successfully"
                break
              else
                echo "âš ï¸  Push failed (attempt $i/3), retrying..."
                sleep 5
                git pull --rebase origin main || true
              fi
            done
          fi
      
      # 8. Afficher les stats
      - name: ğŸ“ˆ Display Statistics
        if: always()
        run: |
          echo ""
          echo "ğŸ“Š ===== OCR SCAN STATISTICS ====="
          if [ -f assets_ocr_index.json ]; then
            python3 << 'EOF'
import json

with open('assets_ocr_index.json', 'r') as f:
    data = json.load(f)

print(f"ğŸ“š Total scanned: {data.get('total_scanned', 0)}")
print(f"ğŸ†• New scans: {data.get('new_scans', 0)}")
print(f"âœ… Successful: {data.get('successful', 0)}")
print(f"âŒ Failed: {data.get('failed', 0)}")

# Compter par type de mÃ©tadonnÃ©e
stats = {
    'with_title': 0,
    'with_composer': 0,
    'with_key': 0,
    'with_techniques': 0
}

for resource_id, resource in data.get('resources', {}).items():
    metadata = resource.get('metadata', {})
    if resource.get('title') and resource['title'] != resource_id:
        stats['with_title'] += 1
    if metadata.get('composer'):
        stats['with_composer'] += 1
    if metadata.get('key'):
        stats['with_key'] += 1
    if metadata.get('techniques'):
        stats['with_techniques'] += 1

print(f"\nğŸµ Metadata found:")
print(f"   Titles: {stats['with_title']}")
print(f"   Composers: {stats['with_composer']}")
print(f"   Keys: {stats['with_key']}")
print(f"   Techniques: {stats['with_techniques']}")
EOF
          else
            echo "âŒ No OCR index found"
          fi
