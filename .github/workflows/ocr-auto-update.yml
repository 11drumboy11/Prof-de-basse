name: ğŸ¤– OCR Auto Update

on:
  push:
    paths:
      - 'Methodes/**'
      - 'Partitions/**'
      - 'Real_Books/**'
      - 'Exercises/**'
      - 'Captures_PNG/**'
  workflow_dispatch:  # Permet de lancer manuellement depuis GitHub

jobs:
  ocr-update:
    runs-on: macos-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # RÃ©cupÃ¨re tout l'historique
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Install Tesseract
        run: |
          brew install tesseract tesseract-lang
          tesseract --version
      
      - name: ğŸ“¦ Install Python dependencies
        run: |
          pip install Pillow pytesseract
      
      - name: ğŸ” Run OCR auto update
        run: |
          cd Prof-de-basse-OCR
          python3 auto_update_index.py
      
      - name: ğŸ“Š Display statistics
        run: |
          cd Prof-de-basse-OCR
          if [ -f search_index.json ]; then
            echo "ğŸ“Š Statistiques de l'index :"
            python3 -c "import json; data=json.load(open('search_index.json')); print(f'Total ressources: {len(data)}')"
          fi
      
      - name: ğŸ’¾ Commit updated index
        run: |
          git config --global user.name 'OCR Bot'
          git config --global user.email 'ocr-bot@prof-de-basse.com'
          git add Prof-de-basse-OCR/search_index.json
          git add Prof-de-basse-OCR/ocr_cache.json
          
          # VÃ©rifier s'il y a des changements
          if git diff --staged --quiet; then
            echo "âœ… Pas de changements dans l'index"
          else
            git commit -m "ğŸ¤– Auto-update OCR index [skip ci]"
            git push
            echo "âœ… Index mis Ã  jour et pushÃ©"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
