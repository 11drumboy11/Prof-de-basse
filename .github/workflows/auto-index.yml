name: ðŸ” Auto-Index & OCR Scan - OPTIMISÃ‰

on:
  push:
    branches: [ main, master ]
    paths:
      - 'Methodes/**'
      - 'Theorie/**'
      - 'Pratique/**'
      - 'Arpeges/**'
      - 'Harmonie/**'
      - '**/*.json'
  workflow_dispatch:

jobs:
  mega-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          pip install Pillow pytesseract beautifulsoup4 lxml
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr tesseract-ocr-fra tesseract-ocr-eng
      
      - name: ðŸ“Š Ã‰TAPE 1: Scan structure
        run: python3 .github/scripts/mega-scanner.py
        continue-on-error: true
      
      - name: ðŸ” Ã‰TAPE 2: OCR sur images
        run: |
          cd Prof-de-basse-OCR
          python3 ocr_scanner_v2.py
        continue-on-error: true
      
      - name: ðŸ”— Ã‰TAPE 3: Fusion index
        run: python3 fusion-all-indexes.py
      
      - name: ðŸŽ¨ Ã‰TAPE 4: GÃ©nÃ©ration index.html
        run: python3 .github/scripts/auto-index-generator.py
        continue-on-error: true
      
      - name: ðŸ“ˆ Afficher statistiques
        run: |
          echo "=== STATISTIQUES FINALES ==="
          
          if [ -f mega-search-index.json ]; then
            echo "âœ… mega-search-index.json gÃ©nÃ©rÃ©"
            python3 -c "
import json
data = json.load(open('mega-search-index.json'))
total = data.get('total_resources', len(data.get('all_resources', [])))
print(f'ðŸ“Š Total ressources: {total}')
            "
          fi
          
          if [ -f scan-report.json ]; then
            echo "âœ… scan-report.json gÃ©nÃ©rÃ©"
          fi
          
          if [ -f Prof-de-basse-OCR/search_index_ocr.json ]; then
            echo "âœ… search_index_ocr.json gÃ©nÃ©rÃ©"
          fi
      
      - name: ðŸ’¾ Commit results
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Ajouter les fichiers gÃ©nÃ©rÃ©s
          git add mega-search-index.json 2>/dev/null || true
          git add scan-report.json 2>/dev/null || true
          git add Prof-de-basse-OCR/search_index_ocr.json 2>/dev/null || true
          git add Methodes/*/index.html 2>/dev/null || true
          
          # Commit seulement si changements
          if ! git diff --quiet --staged; then
            git commit -m "ðŸ¤– Auto-update: index complet [skip ci]
            
- mega-search-index.json
- scan-report.json
- search_index_ocr.json
- index.html (mÃ©thodes)"
          else
            echo "Aucun changement Ã  commiter"
          fi
      
      - name: ðŸš€ Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
