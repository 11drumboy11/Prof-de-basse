name: ğŸ¸ Prof de Basse - Complete Auto-Update

on:
  push:
    branches: [ main, master ]
    paths:
      - 'Methodes/**/*.jpg'
      - 'Methodes/**/*.png'
      - 'Methodes/**/*.jpeg'
      - 'Methodes/**/*.JPG'
      - 'Methodes/**/*.PNG'
  workflow_dispatch:

jobs:
  complete-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Install Tesseract OCR
      run: |
        sudo apt-get update
        sudo apt-get install -y tesseract-ocr tesseract-ocr-fra tesseract-ocr-eng
        tesseract --version
    
    - name: ğŸ“¦ Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install Pillow pytesseract
    
    - name: ğŸ” STEP 1/3 - OCR Scan on all methods
      run: |
        echo "========================================================================"
        echo "ğŸ” STEP 1: OCR Scanning all *_with_index folders"
        echo "========================================================================"
        echo ""
        
        python3 << 'EOF'
        import os
        import json
        from pathlib import Path
        from PIL import Image
        import pytesseract
        
        def extract_title_from_image(img_path):
            """Extract title from top 20% of image using OCR"""
            try:
                img = Image.open(img_path)
                width, height = img.size
                
                # Crop top 20% for title
                top_crop = img.crop((0, 0, width, int(height * 0.2)))
                
                # OCR with both English and French
                text = pytesseract.image_to_string(top_crop, lang='eng+fra')
                text = text.strip()
                
                # Clean up
                if len(text) > 150:
                    text = text[:150] + "..."
                
                return text if text else None
                
            except Exception as e:
                print(f"      âš ï¸  OCR Error: {e}")
                return None
        
        def scan_method_folder(method_path):
            """Scan a method folder and update its songs_index.json"""
            assets_path = method_path / 'assets'
            if not assets_path.exists():
                print(f"      âš ï¸  No assets/ folder found")
                return 0
            
            # Load existing songs_index.json
            index_path = method_path / 'songs_index.json'
            if index_path.exists():
                with open(index_path, 'r', encoding='utf-8') as f:
                    index_data = json.load(f)
            else:
                index_data = {}
            
            initial_count = len(index_data)
            new_items = 0
            
            # Find all image files
            image_extensions = ['.jpg', '.jpeg', '.png', '.JPG', '.JPEG', '.PNG']
            image_files = []
            
            for ext in image_extensions:
                image_files.extend(assets_path.glob(f'page_*{ext}'))
                image_files.extend(assets_path.glob(f'Page_*{ext}'))
            
            for img_file in sorted(image_files):
                # Extract page number
                try:
                    page_num = int(''.join(filter(str.isdigit, img_file.stem)))
                except:
                    page_num = 0
                
                # Create unique key
                key = f"{img_file.stem.lower()}_{page_num}"
                
                # Skip if already indexed
                if key in index_data:
                    continue
                
                # Run OCR
                print(f"      ğŸ” OCR: {img_file.name}")
                title = extract_title_from_image(img_file)
                
                # Add to index
                index_data[key] = {
                    "title": title or f"Page {page_num}",
                    "page": page_num,
                    "file": img_file.name,
                    "format": img_file.suffix[1:].lower()
                }
                
                if title:
                    index_data[key]["ocr_raw"] = title
                
                new_items += 1
            
            # Save updated songs_index.json
            if new_items > 0:
                with open(index_path, 'w', encoding='utf-8') as f:
                    json.dump(index_data, f, indent=2, ensure_ascii=False)
            
            return new_items
        
        # Main execution
        base_path = Path('.')
        total_new = 0
        methods_processed = 0
        
        # Find all *_with_index folders
        for method_path in sorted(base_path.rglob('*_with_index')):
            if not method_path.is_dir():
                continue
            
            # Skip hidden folders
            if any(part.startswith('.') for part in method_path.parts):
                continue
            
            print(f"ğŸ“– Processing: {method_path.name}")
            new_items = scan_method_folder(method_path)
            
            if new_items > 0:
                print(f"      âœ… {new_items} new resources added")
                total_new += new_items
            else:
                print(f"      âœ“ Already up to date")
            
            methods_processed += 1
            print()
        
        print("========================================================================")
        print(f"âœ… OCR Complete: {total_new} new resources added in {methods_processed} methods")
        print("========================================================================")
        print()
        EOF
    
    - name: ğŸ”— STEP 2/3 - Fusion into unified_index.json
      run: |
        echo "========================================================================"
        echo "ğŸ”— STEP 2: Fusing all songs_index.json into unified_index.json"
        echo "========================================================================"
        echo ""
        
        if [ -f "fusion_master_index.py" ]; then
          python3 fusion_master_index.py
        else
          echo "âŒ ERROR: fusion_master_index.py not found!"
          echo "Please make sure fusion_master_index.py is at the root of the repo"
          exit 1
        fi
    
    - name: ğŸ“Š STEP 3/3 - Display statistics
      run: |
        echo ""
        echo "========================================================================"
        echo "ğŸ“Š STEP 3: Final Statistics"
        echo "========================================================================"
        
        if [ -f "unified_index.json" ]; then
          python3 -c "
import json
with open('unified_index.json', 'r', encoding='utf-8') as f:
    data = json.load(f)
    print(f'âœ… Total resources: {data[\"total_resources\"]}')
    print(f'ğŸ“š Total methods: {data[\"total_methods\"]}')
    print(f'ğŸ“… Generated at: {data[\"generated_at\"]}')
"
        else
          echo "âš ï¸  unified_index.json not found"
        fi
        
        echo "========================================================================"
    
    - name: ğŸ”„ Pull latest changes before commit
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git pull --rebase origin ${{ github.ref_name }} || true
    
    - name: ğŸ’¾ Commit changes
      id: commit
      run: |
        git add -A
        
        if git diff --staged --quiet; then
          echo "â„¹ï¸  No changes to commit"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          git commit -m "ğŸ¤– Auto-update: Generated all indexes [$(date +'%Y-%m-%d %H:%M')]"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "âœ… Changes committed"
        fi
    
    - name: ğŸš€ Push changes
      if: steps.commit.outputs.has_changes == 'true'
      run: |
        MAX_RETRIES=3
        RETRY_COUNT=0
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          if git push origin ${{ github.ref_name }}; then
            echo "âœ… Push successful!"
            exit 0
          else
            RETRY_COUNT=$((RETRY_COUNT+1))
            echo "âš ï¸  Push failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
            
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              git pull --rebase origin ${{ github.ref_name }}
              sleep 2
            fi
          fi
        done
        
        echo "âŒ Push failed after $MAX_RETRIES attempts"
        exit 1
    
    - name: ğŸ“ Create summary
      if: always()
      run: |
        echo "# ğŸ¸ Prof de Basse - Auto-Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "unified_index.json" ]; then
          echo "## âœ… Update successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Statistics" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          python3 -c "
import json
with open('unified_index.json', 'r') as f:
    data = json.load(f)
    print(json.dumps({
        'total_resources': data['total_resources'],
        'total_methods': data['total_methods'],
        'generated_at': data['generated_at']
    }, indent=2))
" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.commit.outputs.has_changes }}" == "true" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Changes committed and pushed" >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸  No changes detected" >> $GITHUB_STEP_SUMMARY
        fi
